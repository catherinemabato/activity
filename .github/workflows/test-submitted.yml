# This is the post-merge CI that runs on on code pushed to our main branches.
# It's identical to the CI that runs in PR, with the addition that it notifies
# us in Slack on failure.
name: CI

on:
  pull_request:
    branches:
      - "*"
  push:
    branches:
      - "main"
      - "release-branch/*"

jobs:
  test:
    uses: ./.github/workflows/test.yml

  notify_slack:
    if: failure()
    needs: ["test"]
    runs-on: ubuntu-22.04
    steps:
    - name: notify  
      uses: ruby/action-slack@v3.0.0
      with:
        payload: |
          {
            "attachments": [{
              "title": "TEST TEST TEST I AM DOING A TEST: ${{ github.workflow }}",
              "title_link": "https://github.com/${{ github.repository }}/commit/${{ github.sha }}/checks",         
              "text": "${{ github.repository }}@${{ github.ref_name }}: <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>",
              "fields": [{ "value": ${{ toJson(github.event.head_commit.message) }}, "short": false }],
              "footer": "${{ github.event.head_commit.committer.name }} at ${{ github.event.head_commit.timestamp }}",
              "color": "danger"
            }]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
